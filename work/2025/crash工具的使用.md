# crash工具的使用
## crash 相关命令使用
1. 读取符号地址
sym --> 将符号转换为其虚拟地址，或将虚拟地址转换为对应的符号。

```bash
# 符号 → 地址
crash> sym <symbol_name>  
crash> sym jiffies

# 地址 → 符号
crash> sym <address>      
crash> sym 0xffffffff81123456
```

```txt
 sym [-l] | [-M] | [-m module] | [-p|-n] | [-q string] | [symbol | vaddr]
 
-l：转储所有符号及其值。
-M：转储系统所有模块符号集。
-m module：转储指定模块的当前符号集。
-p：显示目标符号及其前一个符号。
-n：显示目标符号及其后一个符号。
-q string：搜索包含 "string" 的所有符号。
symbol：内核文本或数据符号。
vaddr：内核虚拟地址
```

2. 显示变量值

```txt
 p - 打印表达式的值
  p [-x|-d][-u] [expression | symbol[:cpuspec]]

  expression：要计算的表达式。
symbol：内核符号。
:cpuspec：针对每个 CPU 符号的 CPU 规范：
:：当前选定任务所在的 CPU。
:a[ll]：所有 CPU。
:#[-#][,...]：CPU 列表，例如 "1,3,5"、"1-3" 或 "1,3,5-7,10"。
-x：用十六进制格式覆盖默认输出格式。
-d：用十进制格式覆盖默认输出格式。
-u：表达式求值结果为用户地址引用。
```

默认输出格式为十进制，但可随时通过两个内置别名 "hex" 和 "dec" 进行更改。
此外，还有另外两个内置别名 "px" 和 "pd"，它们会强制命令输出以十六进制或十进制显示，而不改变默认模式。

**注意：模块中的变量需要加载模块后才能打印**

3. 转换虚拟地址为物理地址
vtop - virtual to physical

```txt
vtop [-c [pid | taskp]] [-u|-k] address ...

-u：指定该地址为用户虚拟地址，仅在用户和内核虚拟地址空间存在重叠的处理器上需要使用此选项。
-k：指定该地址为内核虚拟地址，仅在用户和内核虚拟地址空间存在重叠的处理器上需要使用此选项。
-c [pid | taskp]：根据指定进程 ID（PID）或十六进制task_struct指针的页目录来转换虚拟地址
。不过，如果此命令是通过foreach vtop调用的，则不应输入pid或taskp参数
，地址将根据foreach指定的每个任务的页目录进行转换。
address：十六进制格式的用户或内核虚拟地址。
```

4. 打印结构体
struct - structure contents
  struct struct_name[.member[,member]][-o][-l offset][-rfuxdp]
         [address | symbol][:cpuspec] [count | -c count]
         
此命令用于显示结构体定义，或按格式显示指定地址处结构体的内容。若未指定地址，
则会显示结构体定义及其大小。可以在结构体名称后附加成员名，将显示的数据范围限定为该特定成员；
若未指定地址，则会显示该成员的偏移量和定义。

```txt
struct_name：内核使用的 C 代码结构体名称。
.member：结构体成员名。若要显示结构体的多个成员，可使用逗号分隔的成员列表。若任何成员包含
嵌套结构体，或该成员是数组，则可通过将成员参数表示为 "member.member" 或 "member [index]"，
将输出限制为仅显示嵌套结构体或数组元素；嵌套成员说明可通过 "member.member.member..." 的形式扩展到多级深度。
-o：显示结构体定义时显示成员偏移量；若与地址或符号参数一起使用，则每个成员前都会显示其虚拟地址。
-l offset：若地址参数是指向目标数据结构中包含的结构体成员（通常是指向嵌入式 list_head 的指针），
则可通过以下任一方式输入到嵌入式成员的偏移量：
以 "structure.member" 格式输入。
以字节数输入。
-r：原始转储结构体数据。
-f：地址参数是转储文件偏移量。
-u：地址参数是当前上下文中的用户虚拟地址。
-x：用十六进制格式覆盖默认输出格式。
-d：用十进制格式覆盖默认输出格式。
-p：若结构体成员是指针值，则在输出行显示该成员的数据类型；并在后续行中，解引用该指针，在适当情况
下在括号中显示指针目标的符号值，并在可能的情况下显示目标数据；此选项需要地址参数。
address：结构体的十六进制地址；若该地址指向目标数据结构中包含的嵌入式 list_head 结构体，则必须使用 "-l" 选项。
symbol：结构体地址的符号引用。
:cpuspec：针对每个 CPU 的地址或符号的 CPU 规范：
:：当前选定任务所在的 CPU。
:a[ll]：所有 CPU。
:#[-#][,...]：CPU 列表，例如 "1,3,5"、"1-3" 或 "1,3,5-7,10"。
count：从结构体数组中转储的结构体数量；若使用此参数，则必须作为最后一个参数输入。
-c count：仅在 "count" 不是最后一个参数或输入负数时需要使用 "-c"；若输入负值，则会显示直到并包
括目标结构体在内的（正）"count" 个结构体。
```

除非指定了-x或-d选项，否则结构体数据、大小和成员偏移量将以当前输出基数显示。
请注意，在绝大多数情况下，可以省略 "struct"命令名；若结构体名称与任何
 crash_arm64_sprd_v8.0.5++ 或 gdb 命令名不冲突，则"struct_name[.member]" 
 参数将被识别为结构体名称，并自动执行此命令。见下面的注释。

## crash 解析sysdump

* 加载KO
  mod -s sysdump sysdump.ko

* 加载脚本自动执行
  本地编写脚本crash_sh,执行crash时加上 -i crash_sh参数，就会自动执行里面的命令，可以方便的进行批处理和解析

* 打印全局变量地址



# Ufs 重启

![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-17-11-11.png)

![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-49-41.png)

![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-50-21.png)

![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-50-31.png)

![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-50-40.png)

![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-51-02.png)

![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-51-10.png)

Rpmb 读流程：

![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-51-24.png)

![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-51-29.png)

![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-51-39.png)

![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-51-45.png)

![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-51-49.png)

在scsi_execute_req 中具体处理下发的cmd

![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-51-58.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-52-02.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-52-08.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-52-15.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-52-25.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-52-29.png)
首先从blk层申请到req, 再调用 scsi_req 得到scsi的rq,设置好req后调用blk_execute_rq
转入blk层具体处理 该rq
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-52-38.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-52-43.png)
该值是hung_task 检测超时的时间，默认是120s， 如果系统没有打开HUNG_TASK 功能则为0
调用wait_for_completion_io 会在系统IO操作完成后才返回
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-52-48.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-52-54.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-52-59.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-53-03.png)
将请求插入调度队列，然后发送请求到硬件。
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-53-09.png)

当请求超时后没有执行，会调用blk_mq_rq_timed_out 函数做超时后的处理
看下请求队列的初始化以及超时是如何监控的。

![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-53-29.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-53-34.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-53-38.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-53-46.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-53-50.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-53-55.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-53-59.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-54-06.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-54-11.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-54-15.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-54-19.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-54-22.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-54-26.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-54-30.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-54-35.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-54-38.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-54-43.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-54-48.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-54-52.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-55-01.png)
![1](/tmpimage/ufs%20卡住%20重启流程2023-12-07-16-55-05.png)

